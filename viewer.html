<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Camera Viewer - AWS TURN</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      background: #f7f9fc;
      border-radius: 8px;
      margin-top: 15px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ffc107;
      animation: pulse 2s infinite;
    }

    .status-indicator.connected {
      background: #4caf50;
      animation: none;
    }

    .status-indicator.failed {
      background: #f44336;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .camera-count {
      margin-left: auto;
      padding: 6px 12px;
      background: #4caf50;
      color: white;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    /* Grid Layout for Multiple Videos */
    .videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .video-container {
      background: white;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .video-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .camera-label {
      font-weight: 600;
      color: #333;
      font-size: 16px;
    }

    .camera-status {
      padding: 4px 10px;
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .camera-status.active {
      background: #4caf50;
      color: white;
    }

    video {
      width: 100%;
      height: auto;
      max-height: 400px;
      background: #000;
      border-radius: 8px;
      display: block;
    }

    .log-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .log-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .clear-btn {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
    }

    .clear-btn:hover {
      background: #5568d3;
    }

    #log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 8px;
      height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .log-entry {
      margin-bottom: 4px;
    }

    .log-success { color: #4caf50; }
    .log-error { color: #f44336; }
    .log-warning { color: #ffc107; }
    .log-info { color: #2196f3; }

    .turn-info {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 12px;
      margin-top: 15px;
      border-radius: 4px;
    }

    .turn-info strong {
      color: #1976d2;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .videos-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üé• Multi-Camera Viewer - AWS TURN Server</h1>
      
      <div class="status-bar">
        <div class="status-indicator" id="statusIndicator"></div>
        <div class="status-text" id="statusText">Initializing...</div>
        <div class="camera-count" id="cameraCount">Cameras: 0</div>
      </div>

      <div class="turn-info">
        <strong>üîÑ Using YOUR AWS TURN Server:</strong> 52.64.197.245:3478
      </div>
    </div>

    <!-- Video Grid (Multiple Cameras) -->
    <div class="videos-grid" id="videosGrid">
      <!-- Videos will be added here dynamically -->
    </div>

    <!-- Connection Log -->
    <div class="log-container">
      <div class="log-header">
        <div class="log-title">üìã Connection Log</div>
        <button class="clear-btn" onclick="clearLog()">Clear Log</button>
      </div>
      <div id="log"></div>
    </div>
  </div>

  <script>
    // ========================================
    // Configuration
    // ========================================

    const CONFIG = {
      signaling: "wss://camera-relay.onrender.com/ws/viewer1",
      cameraId: "camera1",
      
      turn: {
        ip: "52.64.197.245",
        port: "3478",
        username: "webrtcuser",
        password: "changeThisPassword2025!"
      }
    };

    // ========================================
    // ICE Servers Configuration
    // ========================================

    const ICE_SERVERS = [
      { urls: "stun:stun.l.google.com:19302" },
      {
        urls: `turn:${CONFIG.turn.ip}:${CONFIG.turn.port}?transport=udp`,
        username: CONFIG.turn.username,
        credential: CONFIG.turn.password
      },
      {
        urls: `turn:${CONFIG.turn.ip}:${CONFIG.turn.port}?transport=tcp`,
        username: CONFIG.turn.username,
        credential: CONFIG.turn.password
      }
    ];

    // ========================================
    // UI Elements
    // ========================================

    const logElement = document.getElementById('log');
    const statusText = document.getElementById('statusText');
    const statusIndicator = document.getElementById('statusIndicator');
    const cameraCount = document.getElementById('cameraCount');
    const videosGrid = document.getElementById('videosGrid');

    // Track received cameras
    let receivedCameras = 0;

    // ========================================
    // Logging Functions
    // ========================================

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${timestamp}] ${message}`;
      logElement.appendChild(entry);
      logElement.scrollTop = logElement.scrollHeight;
      console.log(`[${type}]`, message);
    }

    function clearLog() {
      logElement.innerHTML = '';
      log('Log cleared', 'info');
    }

    function setStatus(text, state = 'connecting') {
      statusText.textContent = text;
      statusIndicator.className = `status-indicator ${state}`;
      log(`Status: ${text}`, state === 'connected' ? 'success' : state === 'failed' ? 'error' : 'info');
    }

    function updateCameraCount(count) {
      cameraCount.textContent = `Cameras: ${count}`;
    }

    // ========================================
    // Create Video Element for Each Camera
    // ========================================

    function createVideoElement(track, trackIndex) {
      receivedCameras++;
      updateCameraCount(receivedCameras);

      const container = document.createElement('div');
      container.className = 'video-container';
      container.id = `camera-${trackIndex}`;

      const header = document.createElement('div');
      header.className = 'video-header';

      const label = document.createElement('div');
      label.className = 'camera-label';
      label.textContent = `üìπ Camera ${trackIndex}`;

      const status = document.createElement('div');
      status.className = 'camera-status active';
      status.textContent = 'LIVE';

      header.appendChild(label);
      header.appendChild(status);

      const video = document.createElement('video');
      video.id = `video-${trackIndex}`;
      video.autoplay = true;
      video.playsinline = true;
      video.muted = true;
      video.controls = true;

      // Create a new MediaStream for this track
      const stream = new MediaStream([track]);
      video.srcObject = stream;

      container.appendChild(header);
      container.appendChild(video);
      videosGrid.appendChild(container);

      video.play()
        .then(() => log(`‚ñ∂Ô∏è Camera ${trackIndex} playback started`, 'success'))
        .catch(err => log(`‚ùå Camera ${trackIndex} playback error: ${err.message}`, 'error'));

      log(`‚úÖ Camera ${trackIndex} added to grid`, 'success');
    }

    // ========================================
    // WebRTC Peer Connection Setup
    // ========================================

    log('üöÄ Initializing WebRTC multi-camera viewer...', 'info');
    log(`üîÑ TURN Server: ${CONFIG.turn.ip}:${CONFIG.turn.port}`, 'info');

    const pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });

    // Track counter
    let trackCounter = 0;

    // ========================================
    // ICE Candidate Handling
    // ========================================

    pc.onicecandidate = (event) => {
      if (!event.candidate) {
        log('‚úÖ Local ICE gathering completed', 'success');
        return;
      }

      const candidate = event.candidate.candidate;
      log(`ICE candidate: ${candidate.substring(0, 50)}...`, 'info');

      if (candidate.includes('relay')) {
        log(`üîÑ Using TURN relay from AWS: ${CONFIG.turn.ip}`, 'success');
      }

      if (ws && ws.readyState === WebSocket.OPEN) {
        const message = {
          type: 'ice',
          from: 'viewer1',
          to: CONFIG.cameraId,
          candidate: {
            candidate: event.candidate.candidate,
            sdpMid: event.candidate.sdpMid,
            sdpMLineIndex: event.candidate.sdpMLineIndex
          }
        };
        ws.send(JSON.stringify(message));
      }
    };

    // ========================================
    // Connection State Monitoring
    // ========================================

    pc.onicegatheringstatechange = () => {
      log(`ICE gathering state: ${pc.iceGatheringState}`, 'info');
    };

    pc.oniceconnectionstatechange = () => {
      const state = pc.iceConnectionState;
      log(`ICE connection state: ${state}`, 'info');

      if (state === 'connected') {
        setStatus('‚úÖ Connected - Streaming', 'connected');
      } else if (state === 'disconnected') {
        setStatus('‚ö†Ô∏è Disconnected', 'warning');
      } else if (state === 'failed') {
        setStatus('‚ùå Connection Failed', 'failed');
      }
    };

    pc.onconnectionstatechange = () => {
      const state = pc.connectionState;
      log(`Connection state: ${state}`, 'info');

      if (state === 'connected') {
        log('‚úÖ Peer connection established!', 'success');
      } else if (state === 'failed') {
        log('‚ùå Peer connection failed!', 'error');
      }
    };

    // ========================================
    // Track Handling (Receive Multiple Videos)
    // ========================================

    pc.ontrack = (event) => {
      trackCounter++;
      log(`‚úÖ Received video track ${trackCounter} from camera`, 'success');
      
      // Create separate video element for each track
      createVideoElement(event.track, trackCounter);
    };

    // ========================================
    // WebSocket Signaling
    // ========================================

    let ws;

    try {
      setStatus('Connecting to signaling server...', 'connecting');
      ws = new WebSocket(CONFIG.signaling);
    } catch (err) {
      log(`‚ùå WebSocket error: ${err.message}`, 'error');
      setStatus('‚ùå Connection Failed', 'failed');
      throw err;
    }

    ws.onopen = () => {
      log('‚úÖ Signaling server connected', 'success');
      setStatus('Waiting for camera offer...', 'connecting');
    };

    ws.onclose = () => {
      log('‚ö†Ô∏è Signaling server disconnected', 'warning');
      setStatus('‚ùå Disconnected', 'failed');
    };

    ws.onerror = (error) => {
      log(`‚ùå WebSocket error: ${error}`, 'error');
      setStatus('‚ùå Connection Error', 'failed');
    };

    ws.onmessage = async (event) => {
      try {
        const message = JSON.parse(event.data);
        
        if (message.type === 'offer') {
          log('üì® Received offer from camera (with multiple tracks)', 'info');
          setStatus('Processing offer...', 'connecting');
          
          await pc.setRemoteDescription({
            type: 'offer',
            sdp: message.sdp
          });
          
          log('Creating answer...', 'info');
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          
          ws.send(JSON.stringify({
            type: 'answer',
            from: 'viewer1',
            to: message.from,
            sdp: pc.localDescription.sdp
          }));
          
          log('‚úÖ Answer sent to camera', 'success');
          setStatus('Connecting to cameras...', 'connecting');
        }
        else if (message.type === 'ice') {
          const candidateData = message.candidate;
          if (candidateData && candidateData.candidate) {
            await pc.addIceCandidate({
              candidate: candidateData.candidate,
              sdpMid: candidateData.sdpMid,
              sdpMLineIndex: candidateData.sdpMLineIndex
            });
            log('Added remote ICE candidate', 'info');
          }
        }
      } catch (err) {
        log(`‚ùå Message handling error: ${err.message}`, 'error');
      }
    };

    // ========================================
    // Startup Message
    // ========================================
    log('='.repeat(50), 'info');
    log('Multi-Camera Viewer Initialized', 'info');
    log(`Using YOUR AWS TURN Server: ${CONFIG.turn.ip}:${CONFIG.turn.port}`, 'success');
    log('Waiting for multiple video tracks...', 'info');
    log('='.repeat(50), 'info');
  </script>
</body>
</html>
