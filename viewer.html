<!-- viewer.html -->
<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebRTC Viewer</title>
  </head>
  <body>
    <h3>Viewer</h3>
    <video id="remoteVideo" autoplay playsinline controls style="width:100%;max-height:70vh;background:#000"></video>
    <script>
      const signalingUrl = "wss://camera-relay.onrender.com/ws/viewer1"; 
      const pc = new RTCPeerConnection({
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" }
          // Add TURN here for production
        ]
      });

      const remoteVideo = document.getElementById("remoteVideo");

      pc.ontrack = (event) => {
        console.log("ontrack", event);
        remoteVideo.srcObject = event.streams[0];
      };

      pc.onicecandidate = (evt) => {
        if (evt.candidate) {
          const msg = { type: "ice", from: "viewer1", to: camId, candidate: {
            candidate: evt.candidate.candidate,
            sdpMid: evt.candidate.sdpMid,
            sdpMLineIndex: evt.candidate.sdpMLineIndex
          }};
          ws.send(JSON.stringify(msg));
        }
      };

      let ws = new WebSocket(signalingUrl);
      ws.onopen = () => {
        console.log("WS open", signalingUrl);
      };

      ws.onmessage = async (evt) => {
        console.log("WS msg:", evt.data.slice(0,200));
        const obj = JSON.parse(evt.data);
        if (obj.type === "offer") {
          console.log("Got offer");
          await pc.setRemoteDescription({ type: "offer", sdp: obj.sdp });
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          ws.send(JSON.stringify({ type: "answer", from: "viewer1", to: obj.from, sdp: pc.localDescription.sdp }));
        } else if (obj.type === "ice") {
          try {
            await pc.addIceCandidate({candidate: obj.candidate.candidate, sdpMid: obj.candidate.sdpMid, sdpMLineIndex: obj.candidate.sdpMLineIndex});
            console.log("Added remote ICE");
          } catch (e) { console.warn("addIceCandidate failed", e); }
        }
      };

      ws.onerror = (e) => console.error("WS err", e);
      ws.onclose = () => console.log("WS closed");
    </script>
  </body>
</html>
